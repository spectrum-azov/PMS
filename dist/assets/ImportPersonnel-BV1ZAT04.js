import{j as e}from"./vendor-radix-ByHbWxx8.js";import{g as le,c as J,a as z}from"./vendor-react-BF0FEgLq.js";import{c as K,u as V,g as ce,a as Q,t as $,q as de,r as oe,C as W,B as P,s as pe}from"./index-0aCTP9xq.js";import{r as me}from"./vendor-csv-CpJM9g8Q.js";import{C as X,c as Y,a as ue,d as he,e as xe}from"./card-Dst-uUJd.js";import{I as f}from"./input-BzJ4CQH1.js";import{C as _e}from"./chevron-left-BUxVMVdO.js";import{L as ge}from"./loader-circle-DRKYraLk.js";import{S as fe}from"./save-_qgdHCOf.js";import"./vendor-charts-3qJ5OAaG.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]],ve=K("circle-alert",be);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=[["ellipse",{cx:"12",cy:"5",rx:"9",ry:"3",key:"msslwz"}],["path",{d:"M3 5V19A9 3 0 0 0 21 19V5",key:"1wlel7"}],["path",{d:"M3 12A9 3 0 0 0 21 12",key:"mv7ke4"}]],Ne=K("database",je);var ye=me();const ke=le(ye),Ie=["callsign","fullName","rank","birthDate","serviceType","unitId","positionId","status","phone"];function x(s){return s?s.toLowerCase().replace(/[\s\'\\]+/g,""):""}function Ce(){const s=J(),{t:i}=V(),r=z.useRef(null),{addPerson:m}=ce(),{units:I,positions:n,ranks:b}=Q(),[t,v]=z.useState([]),[C,y]=z.useState(!1),[L,T]=z.useState(!1),[w,D]=z.useState(!1),j=p=>{const l=[];return Ie.forEach(a=>{p[a]||l.push(a)}),{...p,_isValid:l.length===0,_errors:l}},S=p=>{const l=new Set,a=new Set,u=new Set,N=new Set;return p.map(c=>{const o=j({...c});let k=!1;const h=[];if(o.callsign){const A=o.callsign.toLowerCase();l.has(A)?(k=!0,h.push(i("import_duplicate_callsign")||"Позивний")):l.add(A)}return o.militaryId&&(a.has(o.militaryId)?(k=!0,h.push(i("import_duplicate_military")||"Військовий квиток")):a.add(o.militaryId)),o.passport&&(u.has(o.passport)?(k=!0,h.push(i("import_duplicate_passport")||"Паспорт")):u.add(o.passport)),o.taxId&&(N.has(o.taxId)?(k=!0,h.push(i("import_duplicate_tax")||"ІПН")):N.add(o.taxId)),k&&(o._isValid=!1,o._selected=!1,o._errors.push(`${i("import_duplicate")||"Дублікат"}: ${h.join(", ")}`)),o})};return{data:t,isImporting:C,isChecking:L,dbChecked:w,fileInputRef:r,handleFileUpload:p=>{p&&(ke.parse(p,{header:!0,skipEmptyLines:!0,complete:l=>{const a=l.data.map((u,N)=>{const c=d=>{for(const _ of d)if(u[_]!==void 0&&u[_]!==null&&u[_]!=="")return u[_].toString().trim();return""},o=c(["callsign","Позивний","позивний","Callsign"]),k=c(["fullName","fullname","ПІБ","Піб","ПіБ","Full Name","Fullname","Name","Ім'я"]),h=c(["rank","Звання","звання","Rank"]),A=c(["birthDate","birthdate","Дата народження","дата народження","DOB","dob","Дата нар."]),E=c(["unit","unitId","Підрозділ","підрозділ","Unit","Організаційний підрозділ"]),B=c(["position","positionId","Посада","посада","Position","Штатна посада"]),Z=c(["phone","Телефон","телефон","Phone","Номер"]),q=c(["status","Статус","статус","Status"]),M=c(["serviceType","servicetype","Вид служби","вид служби","Service Type"]),F=c(["militaryId","military id","військовий квиток","в/к","Військовий квиток"]),ee=c(["passport","паспорт","Паспорт"]),se=c(["taxId","іпн","ІПН","tax id","Tax ID"]),te=c(["tagNumber","tagnumber","жетон","Жетон","Номер жетона","Tag Number"]),ae=c(["address","адреса","Адреса","Місце проживання","Address"]),ie=c(["registrationAddress","registrationaddress","Адреса реєстрації","Місце реєстрації","Registration Address"]),re=c(["citizenship","громадянство","Громадянство","Citizenship"]),ne=c(["bloodType","bloodtype","Група крові","група крові","Blood Type"]);let R="",H="",O="";if(E){const d=x(E),_=oe.find(g=>x(g.name)===d||g.abbreviation&&x(g.abbreviation)===d||x(g.name).includes(d));_&&(R=_.id)}if(B){const d=x(B),_=n.find(g=>x(g.name)===d||x(g.name).includes(d)||d.includes(x(g.name)));_&&(H=_.id)}if(h){const d=x(h),_=b.find(g=>x(g.name)===d||x(g.name).includes(d)||d.includes(x(g.name)));_&&(O=_.name)}let U="Служить";if(q){const d=x(q);d.includes("переведен")||d.includes("transfer")?U="Переведений":(d.includes("звільнен")||d.includes("discharg")||d.includes("dismiss"))&&(U="Звільнений")}let G="Контракт";if(M){const d=x(M);(d.includes("мобіліз")||d.includes("mobiliz"))&&(G="Мобілізований")}return{_id:`row-${N}-${Date.now()}`,_selected:!0,_isValid:!1,_errors:[],unitId:R,positionId:H,rank:O,callsign:o,fullName:k,birthDate:A,serviceType:G,status:U,phone:Z,militaryId:F,passport:ee,taxId:se,tagNumber:te,address:ae,registrationAddress:ie,citizenship:re,bloodType:ne,roleIds:[]}});v(S(a)),D(!1)},error:l=>{$.error(`${i("import_err_parse")} ${l.message}`)}}),r.current&&(r.current.value=""))},updateRowField:(p,l,a)=>{v(u=>{const N=u.map(c=>c._id===p?{...c,[l]:a}:c);return S(N)})},toggleRowSelection:p=>{v(l=>l.map(a=>a._id===p?{...a,_selected:!a._selected}:a))},toggleAll:p=>{v(l=>l.map(a=>({...a,_selected:p})))},handleCheckDb:async()=>{T(!0);const p=t.map(a=>({callsign:a.callsign||void 0,militaryId:a.militaryId||void 0,passport:a.passport||void 0,taxId:a.taxId||void 0})),l=await de(p);if(!l.success){$.error(l.message),T(!1);return}v(a=>a.map((N,c)=>{const o=l.data[c];if(o&&o.isDuplicate){const k=o.matchedFields.map(h=>h==="callsign"?i("import_duplicate_callsign")||"Позивний":h==="militaryId"?i("import_duplicate_military")||"Військовий квиток":h==="passport"?i("import_duplicate_passport")||"Паспорт":i("import_duplicate_tax")||"ІПН");return{...N,_isValid:!1,_selected:!1,_errors:[...N._errors.filter(h=>!h.includes(i("import_duplicate_db")||"Дублікат (БД)")),`${i("import_duplicate_db")||"Дублікат (БД)"}: ${k.join(", ")}`]}}return N})),D(!0),T(!1),$.success(i("import_db_checked"))},handleImport:async()=>{if(!w){$.error(i("import_check_db_required"));return}y(!0);let p=0;const l=t.filter(a=>a._selected&&a._isValid);if(l.length===0){$.error(i("import_err_no_valid")),y(!1);return}for(const a of l){const u={callsign:a.callsign,fullName:a.fullName,rank:a.rank,birthDate:a.birthDate,serviceType:a.serviceType,unitId:a.unitId,positionId:a.positionId,status:a.status,phone:a.phone,militaryId:a.militaryId||void 0,passport:a.passport||void 0,taxId:a.taxId||void 0,tagNumber:a.tagNumber||void 0,address:a.address||void 0,registrationAddress:a.registrationAddress||void 0,citizenship:a.citizenship||void 0,bloodType:a.bloodType||void 0,roleIds:a.roleIds||[]};await m(u)&&p++}y(!1),p===l.length?($.success(`${i("import_success")} ${p} ${i("import_success_pl")}`),s("/personnel")):($.error(`${i("import_partial")} ${p} ${i("import_partial_out_of")} ${l.length} ${i("import_partial_selected")}`),v(a=>a.filter(u=>u._isValid===!1||!u._selected)))}}}function $e({row:s,toggleRowSelection:i,updateRowField:r}){const{t:m}=V(),{units:I,positions:n,ranks:b}=Q();return e.jsxs("tr",{className:`border-b border-border ${s._isValid?"hover:bg-muted/30":"bg-destructive/10 hover:bg-destructive/20"}`,children:[e.jsx("td",{className:"p-2 text-center sticky left-0 bg-background z-10 border-r border-border shadow-[1px_0_0_0_rgba(0,0,0,0.1)]",children:e.jsx("input",{type:"checkbox",checked:s._selected,onChange:()=>i(s._id)})}),e.jsx("td",{className:"p-2 text-center sticky left-10 bg-background z-10 border-r border-border shadow-[1px_0_0_0_rgba(0,0,0,0.1)]",children:s._isValid?e.jsx(W,{className:"w-5 h-5 text-green-500 inline"}):e.jsx("span",{title:(()=>{const t=s._errors.filter(y=>y.includes(m("import_duplicate")||"Дублікат")),v=s._errors.filter(y=>!y.includes(m("import_duplicate")||"Дублікат")),C=[];return v.length>0&&C.push(`${m("import_missing")} ${v.join(", ")}`),t.length>0&&C.push(t.join(" | ")),C.join(" | ")})(),children:e.jsx(ve,{className:"w-5 h-5 text-destructive inline"})})}),e.jsx("td",{className:"p-2",children:e.jsx(f,{value:s.callsign||"",onChange:t=>r(s._id,"callsign",t.target.value),className:`h-8 min-w-[90px] ${s._errors.includes("callsign")?"border-destructive":""}`})}),e.jsx("td",{className:"p-2",children:e.jsx(f,{value:s.fullName||"",onChange:t=>r(s._id,"fullName",t.target.value),className:`h-8 min-w-[150px] ${s._errors.includes("fullName")?"border-destructive":""}`})}),e.jsx("td",{className:"p-2",children:e.jsxs("select",{value:s.rank||"",onChange:t=>r(s._id,"rank",t.target.value),className:`flex h-8 w-full min-w-[110px] rounded-md border border-input bg-background px-2 py-1 text-sm ${s._errors.includes("rank")?"border-destructive":""}`,children:[e.jsx("option",{value:"",children:m("import_select_rank")}),b.map(t=>e.jsx("option",{value:t.name,children:t.name},t.id))]})}),e.jsx("td",{className:"p-2",children:e.jsx(f,{type:"date",value:s.birthDate||"",onChange:t=>r(s._id,"birthDate",t.target.value),className:`h-8 min-w-[120px] ${s._errors.includes("birthDate")?"border-destructive":""}`})}),e.jsx("td",{className:"p-2",children:e.jsxs("select",{value:s.serviceType||"",onChange:t=>r(s._id,"serviceType",t.target.value),className:`flex h-8 w-full min-w-[120px] rounded-md border border-input bg-background px-2 py-1 text-sm ${s._errors.includes("serviceType")?"border-destructive":""}`,children:[e.jsx("option",{value:"",children:m("import_select_service_type")}),e.jsx("option",{value:"Контракт",children:m("filters_service_contract")}),e.jsx("option",{value:"Мобілізований",children:m("filters_service_mobilized")})]})}),e.jsx("td",{className:"p-2",children:e.jsx(f,{value:s.tagNumber||"",onChange:t=>r(s._id,"tagNumber",t.target.value),className:"h-8 min-w-[80px]"})}),e.jsx("td",{className:"p-2",children:e.jsxs("select",{value:s.unitId||"",onChange:t=>r(s._id,"unitId",t.target.value),className:`flex h-8 min-w-[140px] rounded-md border border-input bg-background px-2 py-1 text-sm ${s._errors.includes("unitId")?"border-destructive":""}`,children:[e.jsx("option",{value:"",children:m("import_select_unit")}),I.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})}),e.jsx("td",{className:"p-2",children:e.jsxs("select",{value:s.positionId||"",onChange:t=>r(s._id,"positionId",t.target.value),className:`flex h-8 min-w-[140px] rounded-md border border-input bg-background px-2 py-1 text-sm ${s._errors.includes("positionId")?"border-destructive":""}`,children:[e.jsx("option",{value:"",children:m("import_select_pos")}),n.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})}),e.jsx("td",{className:"p-2",children:e.jsxs("select",{value:s.status||"",onChange:t=>r(s._id,"status",t.target.value),className:`flex h-8 w-full min-w-[110px] rounded-md border border-input bg-background px-2 py-1 text-sm ${s._errors.includes("status")?"border-destructive":""}`,children:[e.jsx("option",{value:"",children:m("import_select_status")}),e.jsx("option",{value:"Служить",children:m("filters_status_serving")}),e.jsx("option",{value:"Переведений",children:m("filters_status_transferred")}),e.jsx("option",{value:"Звільнений",children:m("filters_status_dismissed")})]})}),e.jsx("td",{className:"p-2",children:e.jsx(f,{value:s.militaryId||"",onChange:t=>r(s._id,"militaryId",t.target.value),className:"h-8 min-w-[120px]"})}),e.jsx("td",{className:"p-2",children:e.jsx(f,{value:s.passport||"",onChange:t=>r(s._id,"passport",t.target.value),className:"h-8 min-w-[100px]"})}),e.jsx("td",{className:"p-2",children:e.jsx(f,{value:s.taxId||"",onChange:t=>r(s._id,"taxId",t.target.value),className:"h-8 min-w-[90px]"})}),e.jsx("td",{className:"p-2",children:e.jsx(f,{value:s.phone||"",onChange:t=>r(s._id,"phone",t.target.value),className:`h-8 min-w-[130px] ${s._errors.includes("phone")?"border-destructive":""}`})}),e.jsx("td",{className:"p-2",children:e.jsx(f,{value:s.address||"",onChange:t=>r(s._id,"address",t.target.value),className:"h-8 min-w-[140px]"})}),e.jsx("td",{className:"p-2",children:e.jsx(f,{value:s.registrationAddress||"",onChange:t=>r(s._id,"registrationAddress",t.target.value),className:"h-8 min-w-[140px]"})}),e.jsx("td",{className:"p-2",children:e.jsx(f,{value:s.citizenship||"",onChange:t=>r(s._id,"citizenship",t.target.value),className:"h-8 min-w-[100px]"})}),e.jsx("td",{className:"p-2",children:e.jsx(f,{value:s.bloodType||"",onChange:t=>r(s._id,"bloodType",t.target.value),className:"h-8 min-w-[100px]"})})]})}function Te({data:s,selectedCount:i,toggleAll:r,toggleRowSelection:m,updateRowField:I}){const{t:n}=V();return e.jsx(X,{children:e.jsx(Y,{className:"p-0",children:e.jsx("div",{className:"w-full overflow-x-auto pb-4",children:e.jsxs("table",{className:"w-full text-sm text-left border-collapse min-w-max",children:[e.jsx("thead",{className:"bg-muted/50 text-muted-foreground border-b border-border",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 w-10 text-center sticky left-0 bg-muted/50 z-10 border-r border-border",children:e.jsx("input",{type:"checkbox",onChange:b=>r(b.target.checked),checked:s.length>0&&i===s.length})}),e.jsx("th",{className:"p-2 w-10 sticky left-10 bg-muted/50 z-10 border-r border-border",children:n("import_col_valid")}),e.jsx("th",{className:"p-2 min-w-[100px]",children:n("import_col_callsign")}),e.jsx("th",{className:"p-2 min-w-[180px]",children:n("import_col_fullname")}),e.jsx("th",{className:"p-2 min-w-[130px]",children:n("import_col_rank")}),e.jsx("th",{className:"p-2 min-w-[130px]",children:n("import_col_dob")}),e.jsx("th",{className:"p-2 min-w-[140px]",children:n("import_col_service_type")}),e.jsx("th",{className:"p-2 min-w-[100px]",children:n("import_col_tag_number")}),e.jsx("th",{className:"p-2 min-w-[180px]",children:n("import_col_unit")}),e.jsx("th",{className:"p-2 min-w-[180px]",children:n("import_col_position")}),e.jsx("th",{className:"p-2 min-w-[120px]",children:n("import_col_service_status")}),e.jsx("th",{className:"p-2 min-w-[140px]",children:n("import_col_military_id")}),e.jsx("th",{className:"p-2 min-w-[120px]",children:n("import_col_passport")}),e.jsx("th",{className:"p-2 min-w-[100px]",children:n("import_col_tax_id")}),e.jsx("th",{className:"p-2 min-w-[140px]",children:n("import_col_phone")}),e.jsx("th",{className:"p-2 min-w-[160px]",children:n("import_col_address")}),e.jsx("th",{className:"p-2 min-w-[160px]",children:n("import_col_reg_address")}),e.jsx("th",{className:"p-2 min-w-[120px]",children:n("import_col_citizenship")}),e.jsx("th",{className:"p-2 min-w-[120px]",children:n("import_col_blood_type")})]})}),e.jsx("tbody",{children:s.map(b=>e.jsx($e,{row:b,toggleRowSelection:m,updateRowField:I},b._id))})]})})})})}function Je(){const s=J(),{t:i}=V(),{data:r,isImporting:m,isChecking:I,dbChecked:n,fileInputRef:b,handleFileUpload:t,updateRowField:v,toggleRowSelection:C,toggleAll:y,handleCheckDb:L,handleImport:T}=Ce(),w=r.filter(j=>j._selected).length,D=r.filter(j=>j._selected&&j._isValid).length;return e.jsxs("div",{className:"p-6 space-y-6 max-w-[1400px] mx-auto",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(P,{variant:"ghost",size:"icon",onClick:()=>s("/personnel"),children:e.jsx(_e,{className:"w-5 h-5"})}),e.jsx("h2",{className:"text-3xl font-semibold text-foreground",children:i("import_title")})]}),e.jsxs(X,{children:[e.jsxs(ue,{children:[e.jsx(he,{children:i("import_upload_title")}),e.jsx(xe,{children:i("import_upload_desc")})]}),e.jsx(Y,{children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("input",{type:"file",accept:".csv",className:"hidden",ref:b,onChange:j=>{var S;return t((S=j.target.files)==null?void 0:S[0])}}),e.jsxs(P,{onClick:()=>{var j;return(j=b.current)==null?void 0:j.click()},variant:"outline",children:[e.jsx(pe,{className:"w-4 h-4 mr-2"})," ",i("import_select_file")]}),r.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs(P,{onClick:L,disabled:I||n,variant:n?"secondary":"outline",children:[I?e.jsx(ge,{className:"w-4 h-4 mr-2 animate-spin"}):n?e.jsx(W,{className:"w-4 h-4 mr-2"}):e.jsx(Ne,{className:"w-4 h-4 mr-2"}),i(I?"import_checking_db":n?"import_db_checked":"import_check_db")]}),e.jsxs(P,{onClick:T,disabled:D===0||m||!n,className:"ml-auto",children:[e.jsx(fe,{className:"w-4 h-4 mr-2"})," ",i("import_btn")," (",D," ",i("import_valid"),")"]})]})]})})]}),r.length>0&&e.jsx(Te,{data:r,selectedCount:w,toggleAll:y,toggleRowSelection:C,updateRowField:v})]})}export{Je as default};
